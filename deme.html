<!DOCTYPE html>
<html>

<head>
    <title>Demeter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" style="text/css" href="deme.css" />
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!--firebase-->
    <script src="https://www.gstatic.com/firebasejs/4.12.1/firebase.js"></script>
</head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-121084620-1"></script>
<script>
//Google Analytics
window.dataLayer = window.dataLayer || [];

function gtag() { dataLayer.push(arguments); }
gtag('js', new Date());
gtag('config', 'UA-121084620-1');


// Initialize Firebase
var config = {
    apiKey: "AIzaSyBqaB_5x6WNZiU5RoSZ4aveLmuMgfs0m_0",
    authDomain: "viban-44f1e.firebaseapp.com",
    databaseURL: "https://viban-44f1e.firebaseio.com",
    projectId: "viban-44f1e",
    storageBucket: "viban-44f1e.appspot.com",
    messagingSenderId: "150917914821"
};
firebase.initializeApp(config);
var dbRef = firebase.database();
//先把uid 儲存起來 之後都可以用
var provider = new firebase.auth.FacebookAuthProvider();
var currentUserId = "";
var exchange = false;

firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
        // User is signed in.
        currentUserId = user.uid
        console.log(currentUserId);
        dbRef.ref("/" + user.uid).on('value', function(snapshot) {
            var demeAmount = snapshot.val().deme;
            console.log(demeAmount);
            $(".coupon").append("<p>" + demeAmount + "</p>");
        })

    } else {
        // User is signed out.
        console.log("user is signed out!")
    }
});


function coupon() {
    exchange = true;
    if (exchange == true) {
        dbRef.ref("/" + currentUserId).once('value', function(snapshot) {
            var demeAmount = snapshot.val().deme;
            console.log(demeAmount);
            demeAmount = demeAmount - 1;
            dbRef.ref(currentUserId).update({
                deme: demeAmount
            });
        });
        exchange = false;
    }
    console.log(exchange);
    $('#myModal').modal('show');
}
</script>

<body>
    <div class="contain">
        <div class="coupon" style="padding-top: 80%; padding-left: 50%; font-size: 20px"></div>
        <button type="button" class="btn btn-info btn-lg" id="home" onclick="window.location.href='index.html'">回首頁</button>
        <div class="bo">
            <button type="button" class="btn btn-info btn-lg" id="collect" onclick="window.location.href='change.html'"></button>
            <button type="button" class="btn btn-info btn-lg" id="change" onclick="coupon()"></button>
        </div>
    </div>
    <div class="container">
        <!-- Modal -->
        <div class="modal fade" id="myModal" role="dialog modal-sm">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">兌換</h4>
                    </div>
                    <div class="modal-body">
                        <p>兌換成功!</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>